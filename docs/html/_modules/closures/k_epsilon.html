

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>closures.k_epsilon &mdash; tunax 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=7ab3649f" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            tunax
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_files/api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">tunax</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">closures.k_epsilon</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for closures.k_epsilon</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:math:`k-\varepsilon` closure parameters, states and computation functions.</span>

<span class="sd">This module contains the implementation of the :math:`k-\varepsilon` model</span>
<span class="sd">described as a GLS case as in [1]_ as a :class:`~closure.Closure` instance. The</span>
<span class="sd">model was traduced from Frotran to JAX with the work of Florian Lemarié and</span>
<span class="sd">Manolis Perrot [2]_, the translation was done in part using the work of Anthony</span>
<span class="sd">Zhou, Linnia Hawkins and Pierre Gentine [3]_. The parameters of the closure are</span>
<span class="sd">available in the :class:`KepsParameters` class, the closure state in</span>
<span class="sd">:class:`KepsState` class. The function :attr:`keps_step` compute one time-step</span>
<span class="sd">of the closure, which means that it computes the eddy-diffusivity and</span>
<span class="sd">viscosity. The module contains other functions that are used by this main one.</span>
<span class="sd">These classes and the function step can be obtained by the prefix</span>
<span class="sd">:code:`tunax.closures.k_epsilon` or directly by :code:`tunax.closures`.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">.. [1] L. Umlauf and H. Burchard. A generic length-scale equation for</span>
<span class="sd">    geophysical turbulence models (2003). Journal of Marine Research 61</span>
<span class="sd">    pp. 235-265. doi : `10.1357/002224003322005087 &lt;https://www.semanticscholar</span>
<span class="sd">    .org/paper/A-generic-length-scale-equation-for-geophysical-Umlauf-Burchard/</span>
<span class="sd">    24fd6403615fc7a6c5d9b6156e4f1e8d4d280af2&gt;`_.</span>
<span class="sd">.. [2] M. Perrot and F. Lemarié. Energetically consistent Eddy-Diffusivity</span>
<span class="sd">    Mass-Flux convective schemes. Part I: Theory and Models (2024). url :</span>
<span class="sd">    `hal.science/hal-04439113 &lt;https://hal.science/hal-04439113&gt;`_.</span>
<span class="sd">.. [3] A. Zhou, L. Hawkins and P. Gentine. Proof-of-concept: Using ChatGPT to</span>
<span class="sd">    Translate and Modernize an Earth System Model from Fortran to Python/JAX</span>
<span class="sd">    (2024). url : `arxiv.org/abs/2405.00018</span>
<span class="sd">    &lt;https://arxiv.org/abs/2405.00018&gt;`_.</span>
<span class="sd">    </span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">equinox</span> <span class="k">as</span> <span class="nn">eqx</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">jaxtyping</span> <span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Array</span>

<span class="kn">from</span> <span class="nn">tunax.case</span> <span class="kn">import</span> <span class="n">Case</span>
<span class="kn">from</span> <span class="nn">tunax.space</span> <span class="kn">import</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">tunax.functions</span> <span class="kn">import</span> <span class="n">tridiag_solve</span><span class="p">,</span> <span class="n">add_boundaries</span>
<span class="kn">from</span> <span class="nn">tunax.closure</span> <span class="kn">import</span> <span class="n">ClosureParametersAbstract</span><span class="p">,</span> <span class="n">ClosureStateAbstract</span>


<div class="viewcode-block" id="KepsParameters">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.KepsParameters">[docs]</a>
<span class="k">class</span> <span class="nc">KepsParameters</span><span class="p">(</span><span class="n">ClosureParametersAbstract</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters and constants for :math:`k-\varepsilon`.</span>

<span class="sd">    The first 17 attributes are the parameters of :math:`k-\varepsilon` that</span>
<span class="sd">    may be calibrated. This class also contains some physical constants used</span>
<span class="sd">    in the closure computing. The last 19 attributes are the one for the</span>
<span class="sd">    stability function that are computed from the parameters of</span>
<span class="sd">    :math:`k-\varepsilon`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c1 : float, default=5.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c2 : float, default=0.8</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c3 : float, default=1.968</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c4 : float, default=1.136</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c5 : float, default=0.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c6 : float, default=0.4</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cb1 : float, default=5.95</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cb2 : float, default=.6</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cb3 : float, default=1.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cb4 : float, default=0.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cb5 : float, default=0.3333</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    cbb : float, default=.72</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_mu0 : float, default=0.5477</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    sig_k : float, default=1.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    sig_eps : float, default=1.3</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_eps1 : float, default=1.44</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_eps2 : float, default=1.92</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_eps3m : float, default=-0.4</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_eps3p : float, default=1.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    chk_grav : float, default=1400.</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    galp: float, default=0.53</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    z0s_min : float, default=1e-2</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    z0b_min : float, default=1e-4</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    z0b : float, default=1e-14</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    akt_min : float, default=1e-5</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    akt_min : float, default=1e-4</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    tke_min : float, default=1e-6</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    eps_min : float, default=1e-12</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_mu_min : float, default=0.1</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    c_mu_prim_min : float, default=0.1</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    dir_sfc: bool, default=False</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    dir_btm: bool, default=True</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    gls_p : float, default=3</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    gls_m : float, default=1.5</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    gls_n : float, default=-1</span>
<span class="sd">        cf. attribute.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    c1 : float, default=5.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_1` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c2 : float, default=0.8</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_2` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c3 : float, default=1.968</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_3` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c4 : float, default=1.136</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_4` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c5 : float, default=0.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_5` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c6 : float, default=0.4</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_6` for the dissipation of the</span>
<span class="sd">        corelation tensor pressure/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cb1 : float, default=5.95</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b1}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cb2 : float, default=.6</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b2}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cb3 : float, default=1.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b3}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cb4 : float, default=0.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b4}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cb5 : float, default=0.3333</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b5}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    cbb : float, default=.72</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{b}` for the dissipation of</span>
<span class="sd">        the corelation tensor buoyancy/velocity (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_mu0 : float, default=0.5477</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_\mu^0` which links the mixing</span>
<span class="sd">        length to the dissipation (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sig_k : float, default=1.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`\sigma_k` Schmit number for the</span>
<span class="sd">        dissipation of TKE (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sig_eps : float, default=1.3</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`\sigma_\varepsilon` Schmit</span>
<span class="sd">        number for the dissipation of :math:`\varepsilon` (Umlauf and Burchard</span>
<span class="sd">        notations) :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_eps1 : float, default=1.44</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{\varepsilon 1}` correction of</span>
<span class="sd">        the :math:`\varepsilon` equation (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_eps2 : float, default=1.92</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{\varepsilon 2}` correction of</span>
<span class="sd">        the :math:`\varepsilon` equation (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_eps3m : float, default=-0.4</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{\varepsilon 3}^-` correction</span>
<span class="sd">        of the :math:`\varepsilon` equation (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_eps3p : float, default=1.</span>
<span class="sd">        :math:`k-\varepsilon` parameter :math:`c_{\varepsilon 3}^+` correction</span>
<span class="sd">        of the :math:`\varepsilon` equation (Umlauf and Burchard notations)</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    chk_grav : float, default=1400.</span>
<span class="sd">        Charnock coefficient times gravity :math:`[\text{dimensionless}]`.</span>
<span class="sd">    galp: float, default=0.53</span>
<span class="sd">        Parameter for Galperin mixing length limitation</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    z0s_min : float, default=1e-2</span>
<span class="sd">        Minimal surface roughness length :math:`[\text m]`.</span>
<span class="sd">    z0b_min : float, default=1e-4</span>
<span class="sd">        Minimal bottom roughness length :math:`[\text m]`.</span>
<span class="sd">    z0b : float, default=1e-14</span>
<span class="sd">        Bottom roughness length :math:`[\text m]`.</span>
<span class="sd">    akt_min : float, default=1e-5</span>
<span class="sd">        Minimal and initialization value of eddy-diffusivity</span>
<span class="sd">        :math:`\left[\text m^2 \cdot \text s^{-1} \right]`.</span>
<span class="sd">    akv_min : float, default=1e-4</span>
<span class="sd">        Minimal and initialization value of eddy-viscosity</span>
<span class="sd">        :math:`\left[\text m^2 \cdot \text s^{-1} \right]`.</span>
<span class="sd">    tke_min : float, default=1e-6</span>
<span class="sd">        Minimal and initialization value of turbulent kinetic energy (TKE)</span>
<span class="sd">        :math:`\left[\text m^3 \cdot \text s^{-2} \right]`.</span>
<span class="sd">    eps_min : float, default=1e-12</span>
<span class="sd">        Minimal and initialization value of TKE dissipation</span>
<span class="sd">        :math:`\left[\text m^2 \cdot \text s^{-3} \right]`.</span>
<span class="sd">    c_mu_min : float, default=0.1</span>
<span class="sd">        Minimal and initialization value of :math:`c_\mu` in GLS formalisim</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_mu_prim_min : float, default=0.1</span>
<span class="sd">        Minimal and initialization value of `c_\mu&#39;` in GLS formalisim</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    dir_sfc: bool, default=False</span>
<span class="sd">        Apply a Dirichlet boundary condition at the surface for TKE, else</span>
<span class="sd">        apply a Neumann boundary condition.</span>
<span class="sd">    dir_btm: bool, default=True</span>
<span class="sd">        Apply a Dirichlet boundary condition at the bottom for TKE, else</span>
<span class="sd">        apply a Neumann boundary condition.</span>
<span class="sd">    gls_p : float, default=3</span>
<span class="sd">        GLS coefficient :math:`p` to define :math:`k-\varepsilon`</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    gls_m : float, default=1.5</span>
<span class="sd">        GLS coefficient :math:`m` to define :math:`k-\varepsilon`</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    gls_n : float, default=-1</span>
<span class="sd">        GLS coefficient :math:`n` to define :math:`k-\varepsilon`</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d0 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d1 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d2 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d3 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d4 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_d5 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_n0 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_n1 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_n2 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_nb0 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_nb1 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    sf_nb2 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am0 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am1 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am2 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am3 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am4 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am5 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    lim_am6 : float (not a parameter, computed from the above attributes)</span>
<span class="sd">        Limitation coefficient for :math:`k-\varepsilon` computed from the</span>
<span class="sd">        parameters :math:`[\text{dimensionless}]`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># k-epsilon coefficients (Umlauf and Burchard notations)</span>
    <span class="n">c1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.</span>
    <span class="n">c2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.8</span>
    <span class="n">c3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.968</span>
    <span class="n">c4</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.136</span>
    <span class="n">c5</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">c6</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.4</span>
    <span class="n">cb1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.95</span>
    <span class="n">cb2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.6</span>
    <span class="n">cb3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">cb4</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">cb5</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3333</span>
    <span class="n">cbb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.72</span>
    <span class="n">c_mu0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5477</span>
    <span class="n">sig_k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">sig_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.3</span>
    <span class="n">c_eps1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.44</span>
    <span class="n">c_eps2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.92</span>
    <span class="n">c_eps3m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.4</span>
    <span class="n">c_eps3p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># physical constants</span>
    <span class="n">chk_grav</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1400.</span>
    <span class="n">galp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.53</span>
    <span class="n">z0s_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">z0b_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">z0b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-14</span>
    <span class="n">akt_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">akv_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">tke_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">eps_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="n">c_mu_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.1</span>
    <span class="n">c_mu_prim_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.1</span>
    <span class="c1"># physical case</span>
    <span class="n">dir_sfc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dir_btm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># GLS coefficient for k-epsilon</span>
    <span class="n">gls_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">gls_m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">gls_n</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># limitation coefficients computed from k-epsilon coefficients</span>
    <span class="n">sf_d0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_d1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_d2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_d3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_d4</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_d5</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_n0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_n1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_n2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_nb0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_nb1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sf_nb2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am4</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am5</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lim_am6</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># stability function coefficients</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="mf">.66666666667</span> <span class="o">-</span> <span class="mf">.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c3</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c4</span>
        <span class="n">a5</span> <span class="o">=</span> <span class="mf">.5</span> <span class="o">-</span> <span class="mf">.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c6</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb1</span>
        <span class="n">ab1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb2</span>
        <span class="n">ab2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb3</span>
        <span class="n">ab3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb4</span><span class="p">)</span>
        <span class="n">ab5</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cbb</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cb5</span><span class="p">)</span>
        <span class="n">sf_d0</span> <span class="o">=</span> <span class="mi">36</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_d1</span> <span class="o">=</span> <span class="mi">84</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span> <span class="o">+</span> <span class="mi">36</span><span class="o">*</span><span class="n">ab5</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_d2</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="p">(</span><span class="n">ab2</span><span class="o">*</span><span class="n">ab2</span> <span class="o">-</span> <span class="n">ab1</span><span class="o">*</span><span class="n">ab1</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span> <span class="o">-</span> <span class="mi">12</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">a2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="o">*</span><span class="n">a3</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_d3</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">ab1</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="o">*</span><span class="n">ab2</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span> <span class="o">+</span> \
            <span class="mi">12</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="p">(</span><span class="n">a3</span><span class="o">*</span><span class="n">a3</span> <span class="o">-</span> <span class="n">a2</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span><span class="o">*</span><span class="n">nb</span> <span class="o">+</span> <span class="mi">12</span><span class="o">*</span><span class="n">ab5</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="o">*</span><span class="n">a3</span> <span class="o">-</span> <span class="n">a2</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_d4</span> <span class="o">=</span> <span class="mi">48</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">nn</span> <span class="o">+</span> <span class="mi">36</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">ab5</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span>
        <span class="n">sf_d5</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">a2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="o">*</span><span class="n">a3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ab1</span><span class="o">*</span><span class="n">ab1</span> <span class="o">-</span> <span class="n">ab2</span><span class="o">*</span><span class="n">ab2</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span>
        <span class="n">sf_n0</span> <span class="o">=</span> <span class="mi">36</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_n1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="p">(</span><span class="n">ab1</span> <span class="o">+</span> <span class="n">ab2</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span> <span class="o">+</span> \
            <span class="mi">8</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span> <span class="o">+</span> <span class="mi">36</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">ab5</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_n2</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="n">ab2</span><span class="o">*</span><span class="n">ab2</span> <span class="o">-</span> <span class="n">ab1</span><span class="o">*</span><span class="n">ab1</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span>
        <span class="n">sf_nb0</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">sf_nb1</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">a5</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span>
        <span class="n">sf_nb2</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="p">(</span><span class="n">ab1</span> <span class="o">-</span> <span class="n">ab2</span><span class="p">)</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nn</span> <span class="o">+</span> \
            <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">a2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">a3</span><span class="o">*</span><span class="n">a3</span><span class="p">))</span><span class="o">*</span><span class="n">ab3</span><span class="o">*</span><span class="n">nn</span><span class="o">*</span><span class="n">nb</span>
        <span class="n">lim_am0</span> <span class="o">=</span> <span class="n">sf_d0</span><span class="o">*</span><span class="n">sf_n0</span>
        <span class="n">lim_am1</span> <span class="o">=</span> <span class="n">sf_d0</span><span class="o">*</span><span class="n">sf_n1</span> <span class="o">+</span> <span class="n">sf_d1</span><span class="o">*</span><span class="n">sf_n0</span>
        <span class="n">lim_am2</span> <span class="o">=</span> <span class="n">sf_d1</span><span class="o">*</span><span class="n">sf_n1</span> <span class="o">+</span> <span class="n">sf_d4</span><span class="o">*</span><span class="n">sf_n0</span>
        <span class="n">lim_am3</span> <span class="o">=</span> <span class="n">sf_d4</span><span class="o">*</span><span class="n">sf_n1</span>
        <span class="n">lim_am4</span> <span class="o">=</span> <span class="n">sf_d2</span><span class="o">*</span><span class="n">sf_n0</span>
        <span class="n">lim_am5</span> <span class="o">=</span> <span class="n">sf_d2</span><span class="o">*</span><span class="n">sf_n1</span> <span class="o">+</span> <span class="n">sf_d3</span><span class="o">*</span><span class="n">sf_n0</span>
        <span class="n">lim_am6</span> <span class="o">=</span> <span class="n">sf_d3</span><span class="o">*</span><span class="n">sf_n1</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d0&#39;</span><span class="p">,</span> <span class="n">sf_d0</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d1&#39;</span><span class="p">,</span> <span class="n">sf_d1</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d2&#39;</span><span class="p">,</span> <span class="n">sf_d2</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d3&#39;</span><span class="p">,</span> <span class="n">sf_d3</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d4&#39;</span><span class="p">,</span> <span class="n">sf_d4</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_d5&#39;</span><span class="p">,</span> <span class="n">sf_d5</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_n0&#39;</span><span class="p">,</span> <span class="n">sf_n0</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_n1&#39;</span><span class="p">,</span> <span class="n">sf_n1</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_n2&#39;</span><span class="p">,</span> <span class="n">sf_n2</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_nb0&#39;</span><span class="p">,</span> <span class="n">sf_nb0</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_nb1&#39;</span><span class="p">,</span> <span class="n">sf_nb1</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sf_nb2&#39;</span><span class="p">,</span> <span class="n">sf_nb2</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am0&#39;</span><span class="p">,</span> <span class="n">lim_am0</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am1&#39;</span><span class="p">,</span> <span class="n">lim_am1</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am2&#39;</span><span class="p">,</span> <span class="n">lim_am2</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am3&#39;</span><span class="p">,</span> <span class="n">lim_am3</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am4&#39;</span><span class="p">,</span> <span class="n">lim_am4</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am5&#39;</span><span class="p">,</span> <span class="n">lim_am5</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lim_am6&#39;</span><span class="p">,</span> <span class="n">lim_am6</span><span class="p">)</span></div>



<div class="viewcode-block" id="KepsState">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.KepsState">[docs]</a>
<span class="k">class</span> <span class="nc">KepsState</span><span class="p">(</span><span class="n">ClosureStateAbstract</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the state of the water column for the :math:`k-\varepsilon` model.</span>

<span class="sd">    The first initilisation is done from the minimal values of the different</span>
<span class="sd">    variables given in an instance of :class:&#39;KepsParameters`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : Grid</span>
<span class="sd">        cf. attribute.</span>
<span class="sd">    keps_params : KepsParameters</span>
<span class="sd">        Used to define the initialization values of the variables.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : Grid</span>
<span class="sd">        Geometry of the water column, should be the same than for the</span>
<span class="sd">        :class:`~space.State` instance used in the model.</span>
<span class="sd">    akt : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Eddy-diffusivity on the interfaces of the cells</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    akv : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Eddy-viscosity on the interfaces of the cells</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    tke :  Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Turbulent kinetic energy (TKE) denoted :math:`k` on the interfaces of</span>
<span class="sd">        the cells :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]`.</span>
<span class="sd">    eps :  Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        TKE dissipation denoted :math:`\varepsilon` on the interfaces of the</span>
<span class="sd">        cells :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    c_mu :  Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        :math:`c_\mu` in GLS formalisim on the interfaces of the cells</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_mu_prim :  Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        :math:`c_\mu&#39;` in GLS formalisim on the interfaces of the cells</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid</span><span class="p">:</span> <span class="n">Grid</span>
    <span class="n">akt</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>
    <span class="n">akv</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>
    <span class="n">tke</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>
    <span class="n">eps</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>
    <span class="n">c_mu</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>
    <span class="n">c_mu_prim</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">keps_params</span><span class="p">:</span> <span class="n">KepsParameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">nz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">akt</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">akt_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">akv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">akv_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tke</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">tke_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">eps_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_mu_prim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_prim_min</span><span class="p">)</span></div>



<div class="viewcode-block" id="keps_step">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.keps_step">[docs]</a>
<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;case&#39;</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">keps_step</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
        <span class="n">keps_state</span><span class="p">:</span> <span class="n">KepsState</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">keps_params</span><span class="p">:</span> <span class="n">KepsParameters</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="n">Case</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KepsState</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run one time-step of the :math:`k-\varepsilon` closure.</span>

<span class="sd">    The purpose of this function is to get the eddy-diffusivity and</span>
<span class="sd">    eddy-viscosity at the next time-step. It works in 3 steps</span>

<span class="sd">    1. The Brunt–Väisälä frequency and the shear is computed from the</span>
<span class="sd">       :code:`state` and the boundary conditions are computed.</span>
<span class="sd">    2. The equations on :math:`k` and :math:`\varepsilon` are solved and their</span>
<span class="sd">       values are computed for the next time step.</span>
<span class="sd">    3. The eddy-diffusivity and viscosity are computed as diagnostic variables</span>
<span class="sd">       and the :math:`keps_state` is updated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state : State</span>
<span class="sd">        Current state of the water column.</span>
<span class="sd">    keps_state : KepsState</span>
<span class="sd">        Current state of the water column for the variables used by</span>
<span class="sd">        :math:`k-\varepsilon`.</span>
<span class="sd">    dt : float</span>
<span class="sd">        Time-step of the forward model :math:`[\text s]`.</span>
<span class="sd">    keps_params: KepsParameters</span>
<span class="sd">        Values of the parameters used by :math:`k-\varepsilon` (time-</span>
<span class="sd">        independant).</span>
<span class="sd">    case : Case</span>
<span class="sd">        Physical parameters and forcings of the model run.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    keps_state : KepsState</span>
<span class="sd">            State of the water column for the variables used by</span>
<span class="sd">            :math:`k-\varepsilon` at the next time-step.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This function is jitted with JAX, it should make it faster, but the</span>
<span class="sd">    :func:`~jax.jit` decorator can be removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">akt</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">akt</span>
    <span class="n">akv</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">akv</span>
    <span class="n">tke</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">tke</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">c_mu</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">c_mu</span>
    <span class="n">c_mu_prim</span> <span class="o">=</span> <span class="n">keps_state</span><span class="o">.</span><span class="n">c_mu_prim</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">u</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">v</span>
    <span class="n">zr</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">zr</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">hz</span>

    <span class="c1"># prognostic computations</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">bvf</span> <span class="o">=</span> <span class="n">compute_rho_eos</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">zr</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
    <span class="n">shear2</span> <span class="o">=</span> <span class="n">compute_shear</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zr</span><span class="p">)</span>
    <span class="n">tke_sfc_bc</span><span class="p">,</span> <span class="n">tke_btm_bc</span><span class="p">,</span> <span class="n">eps_sfc_bc</span><span class="p">,</span> <span class="n">eps_btm_bc</span> <span class="o">=</span> <span class="n">compute_tke_eps_bc</span><span class="p">(</span>
        <span class="n">tke</span><span class="p">,</span> <span class="n">hz</span><span class="p">,</span> <span class="n">keps_params</span><span class="p">,</span> <span class="n">case</span>
    <span class="p">)</span>

    <span class="c1"># integrations</span>
    <span class="n">tke_new</span> <span class="o">=</span> <span class="n">advance_turb</span><span class="p">(</span>
        <span class="n">akt</span><span class="p">,</span> <span class="n">akv</span><span class="p">,</span> <span class="n">tke</span><span class="p">,</span> <span class="n">tke</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">c_mu</span><span class="p">,</span> <span class="n">c_mu_prim</span><span class="p">,</span> <span class="n">bvf</span><span class="p">,</span> <span class="n">shear2</span><span class="p">,</span> <span class="n">hz</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">tke_sfc_bc</span><span class="p">,</span> <span class="n">tke_btm_bc</span><span class="p">,</span> <span class="n">eps_sfc_bc</span><span class="p">,</span> <span class="n">eps_btm_bc</span><span class="p">,</span> <span class="n">keps_params</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">eps_new</span> <span class="o">=</span> <span class="n">advance_turb</span><span class="p">(</span>
        <span class="n">akt</span><span class="p">,</span> <span class="n">akv</span><span class="p">,</span> <span class="n">tke</span><span class="p">,</span> <span class="n">tke_new</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">c_mu</span><span class="p">,</span> <span class="n">c_mu_prim</span><span class="p">,</span> <span class="n">bvf</span><span class="p">,</span> <span class="n">shear2</span><span class="p">,</span> <span class="n">hz</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">tke_sfc_bc</span><span class="p">,</span> <span class="n">tke_btm_bc</span><span class="p">,</span> <span class="n">eps_sfc_bc</span><span class="p">,</span> <span class="n">eps_btm_bc</span><span class="p">,</span> <span class="n">keps_params</span><span class="p">,</span> <span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># diagnostic variables</span>
    <span class="n">akt_new</span><span class="p">,</span> <span class="n">akv_new</span><span class="p">,</span> <span class="n">eps_new</span><span class="p">,</span> <span class="n">c_mu_new</span><span class="p">,</span> <span class="n">c_mu_prim_new</span> <span class="o">=</span> <span class="n">compute_diag</span><span class="p">(</span>
        <span class="n">tke_new</span><span class="p">,</span> <span class="n">eps_new</span><span class="p">,</span> <span class="n">bvf</span><span class="p">,</span> <span class="n">shear2</span><span class="p">,</span> <span class="n">keps_params</span>
    <span class="p">)</span>

    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">akv</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">akv_new</span><span class="p">)</span>
    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">akt</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">akt_new</span><span class="p">)</span>
    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">tke</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">tke_new</span><span class="p">)</span>
    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">eps_new</span><span class="p">)</span>
    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">c_mu</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">c_mu_new</span><span class="p">)</span>
    <span class="n">keps_state</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">c_mu_prim</span><span class="p">,</span> <span class="n">keps_state</span><span class="p">,</span> <span class="n">c_mu_prim_new</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keps_state</span></div>



<div class="viewcode-block" id="compute_rho_eos">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.compute_rho_eos">[docs]</a>
<span class="k">def</span> <span class="nf">compute_rho_eos</span><span class="p">(</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">s</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">zr</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">case</span><span class="p">:</span> <span class="n">Case</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute density anomaly and Brunt–Väisälä frequency.</span>
<span class="sd">    </span>
<span class="sd">    Prognostic computation via linear Equation Of State (EOS) :</span>

<span class="sd">    :math:`\rho = \rho_0(1-\alpha (T-T_0) + \beta (S-S_0))`</span>

<span class="sd">    :math:`N^2 = - \dfrac g {\rho_0} \partial_z \rho`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Temperature on the center of the cells :math:`[° \text C]`.</span>
<span class="sd">    s : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Salinity on the center of the cells :math:`[\text{psu}]`.</span>
<span class="sd">    zr : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Depths of cell centers from deepest to shallowest :math:`[\text m]`</span>
<span class="sd">    case : Case</span>
<span class="sd">        Physical parameters and forcings of the model run.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bvf : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        Brunt–Väisälä frequency squared :math:`N^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text s^{-2}\right]`.</span>
<span class="sd">    rho : Float[Array, &#39;nz&#39;]</span>
<span class="sd">        Density anomaly :math:`\rho` on cell interfaces </span>
<span class="sd">        :math:`\left[\text {kg} \cdot \text m^{-3}\right]`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho0</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">rho0</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">case</span><span class="o">.</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">case</span><span class="o">.</span><span class="n">t_rho_ref</span><span class="p">)</span> <span class="o">+</span> \
                  <span class="k">case</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">case</span><span class="o">.</span><span class="n">s_rho_ref</span><span class="p">))</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">zr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">zr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bvf_in</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cff</span><span class="o">*</span><span class="n">case</span><span class="o">.</span><span class="n">grav</span><span class="o">/</span><span class="n">rho0</span> <span class="o">*</span> <span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bvf</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">bvf_in</span><span class="p">,</span> <span class="n">bvf_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">bvf</span></div>



<div class="viewcode-block" id="compute_shear">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.compute_shear">[docs]</a>
<span class="k">def</span> <span class="nf">compute_shear</span><span class="p">(</span>
        <span class="n">u_n</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">v_n</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">u_np1</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">v_np1</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">zr</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute shear production term for TKE equation.</span>

<span class="sd">    The prognostic equations are</span>

<span class="sd">    :math:`S_h^2 = \partial_Z U^n \cdot \partial_z U^{n+1/2}`</span>

<span class="sd">    where :math:`U^{n+1/2}` is the mean between :math:`U^n` and</span>
<span class="sd">    :math:`U^{n+1}`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u_n : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Current zonal velocity on the center of the cells</span>
<span class="sd">        :math:`\left[\text m \cdot \text s^{-1}\right]`.</span>
<span class="sd">    v_n : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Current meridional velocity on the center of the cells</span>
<span class="sd">        :math:`\left[\text m \cdot \text s^{-1}\right]`.</span>
<span class="sd">    u_np1 : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Zonal velocity on the center of the cells at the next time step</span>
<span class="sd">        :math:`\left[\text m \cdot \text s^{-1}\right]`.</span>
<span class="sd">    v_np1 : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Meridional velocity on the center of the cells at the next time step</span>
<span class="sd">        :math:`\left[\text m \cdot \text s^{-1}\right]`.</span>
<span class="sd">    zr : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Depths of cell centers from deepest to shallowest :math:`[\text m]`</span>
<span class="sd">        </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shear2 : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Shear production squared :math:`S_h^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">zr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">zr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">du</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cff</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">u_np1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">u_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">u_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">u_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">u_np1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">v_np1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">v_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">v_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">v_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v_np1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shear2_in</span> <span class="o">=</span> <span class="n">du</span> <span class="o">+</span> <span class="n">dv</span>
    <span class="k">return</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shear2_in</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_tke_eps_bc">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.compute_tke_eps_bc">[docs]</a>
<span class="k">def</span> <span class="nf">compute_tke_eps_bc</span><span class="p">(</span>
        <span class="n">tke</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">hz</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">keps_params</span><span class="p">:</span> <span class="n">KepsParameters</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="n">Case</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute top and bottom boundary conditions for TKE and :math:`\varepsilon`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tke : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Turbulent kinetic energy (TKE) denoted :math:`k` on the interfaces of</span>
<span class="sd">        the cells :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]`.</span>
<span class="sd">    hz : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Thickness of cells from deepest to shallowest :math:`[\text m]`.</span>
<span class="sd">    keps_params : KepsParameters</span>
<span class="sd">        Values of the parameters used by :math:`k-\varepsilon`.</span>
<span class="sd">    case : Case</span>
<span class="sd">        Physical parameters and forcings of the model run.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tke_sfc_bc : float</span>
<span class="sd">        TKE value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-3}\right]`).</span>
<span class="sd">    tke_btm_bc : float</span>
<span class="sd">        TKE value for bottom boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-3}\right]`).</span>
<span class="sd">    eps_sfc_bc : float</span>
<span class="sd">        :math:`\varepsilon` value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-4}\right]`).</span>
<span class="sd">    eps_btm_bc : float</span>
<span class="sd">        :math:`\varepsilon` value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-4}\right]`).</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The kind of boundary conditions between Neumann and Dirichlet are register</span>
<span class="sd">    in the parameters :code:`keps_params`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># constants</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rn</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_p</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_m</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_n</span>
    <span class="n">c_mu0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu0</span>
    <span class="n">cm0inv2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">c_mu0</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">vkarmn</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">vkarmn</span>
    <span class="n">chk</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">chk_grav</span><span class="o">/</span><span class="n">case</span><span class="o">.</span><span class="n">grav</span>
    <span class="n">sig_eps</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sig_eps</span>

    <span class="c1"># velocity scales</span>
    <span class="n">ustar2_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">ustr_sfc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">case</span><span class="o">.</span><span class="n">vstr_sfc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ustar2_bot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">ustr_btm</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">case</span><span class="o">.</span><span class="n">vstr_btm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># TKE Dirichlet boundary condition</span>
    <span class="n">tke_sfc_dir</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">tke_min</span><span class="p">,</span> <span class="n">cm0inv2</span><span class="o">*</span><span class="n">ustar2_sfc</span><span class="p">)</span>
    <span class="n">tke_btm_dir</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">tke_min</span><span class="p">,</span> <span class="n">cm0inv2</span><span class="o">*</span><span class="n">ustar2_bot</span><span class="p">)</span>

    <span class="c1"># TKE Neumann boundary condition</span>
    <span class="n">tke_sfc_neu</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tke_btm_neu</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># epsilon surface conditions</span>
    <span class="n">z0_s</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">z0s_min</span><span class="p">,</span> <span class="n">chk</span><span class="o">*</span><span class="n">ustar2_sfc</span><span class="p">)</span>
    <span class="n">lgthsc</span> <span class="o">=</span> <span class="n">vkarmn</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">hz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">z0_s</span><span class="p">)</span>
    <span class="n">tke_sfc</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tke</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">tke</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">eps_sfc_dir</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">eps_min</span><span class="p">,</span> \
        <span class="n">c_mu0</span><span class="o">**</span><span class="n">rp</span> <span class="o">*</span> <span class="n">lgthsc</span><span class="o">**</span><span class="n">rn</span> <span class="o">*</span> <span class="n">tke_sfc</span><span class="o">**</span><span class="n">rm</span><span class="p">)</span>
    <span class="n">eps_sfc_neu</span> <span class="o">=</span> <span class="o">-</span><span class="n">rn</span><span class="o">*</span><span class="n">vkarmn</span><span class="o">/</span><span class="n">sig_eps</span> <span class="o">*</span> <span class="n">c_mu0</span><span class="o">**</span><span class="p">(</span><span class="n">rp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">tke_sfc</span><span class="o">**</span><span class="p">(</span><span class="n">rm</span><span class="o">+</span><span class="mf">.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lgthsc</span><span class="o">**</span><span class="n">rn</span>

    <span class="c1"># epsilon bottom conditions</span>
    <span class="n">z0b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">z0b</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">z0b_min</span><span class="p">)</span>
    <span class="n">lgthsc</span> <span class="o">=</span> <span class="n">vkarmn</span> <span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">hz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">z0b</span><span class="p">)</span>
    <span class="n">tke_btm</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tke</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eps_btm_dir</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">eps_min</span><span class="p">,</span> \
        <span class="n">c_mu0</span><span class="o">**</span><span class="n">rp</span> <span class="o">*</span> <span class="n">lgthsc</span><span class="o">**</span><span class="n">rn</span> <span class="o">*</span> <span class="n">tke_btm</span><span class="o">**</span><span class="n">rm</span><span class="p">)</span>
    <span class="n">eps_btm_neu</span> <span class="o">=</span> <span class="o">-</span><span class="n">rn</span><span class="o">*</span><span class="n">vkarmn</span><span class="o">/</span><span class="n">sig_eps</span> <span class="o">*</span> <span class="n">c_mu0</span><span class="o">**</span><span class="p">(</span><span class="n">rp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">tke_btm</span><span class="o">**</span><span class="p">(</span><span class="n">rm</span><span class="o">+</span><span class="mf">.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lgthsc</span><span class="o">**</span><span class="n">rn</span>

    <span class="n">tke_sfc_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="n">tke_sfc_dir</span><span class="p">,</span> <span class="n">tke_sfc_neu</span><span class="p">)</span>
    <span class="n">tke_btm_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">dir_btm</span><span class="p">,</span> <span class="n">tke_btm_dir</span><span class="p">,</span> <span class="n">tke_btm_neu</span><span class="p">)</span>
    <span class="n">eps_sfc_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="n">eps_sfc_dir</span><span class="p">,</span> <span class="n">eps_sfc_neu</span><span class="p">)</span>
    <span class="n">eps_btm_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">dir_btm</span><span class="p">,</span> <span class="n">eps_btm_dir</span><span class="p">,</span> <span class="n">eps_btm_neu</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tke_sfc_bc</span><span class="p">,</span> <span class="n">tke_btm_bc</span><span class="p">,</span> <span class="n">eps_sfc_bc</span><span class="p">,</span> <span class="n">eps_btm_bc</span></div>



<div class="viewcode-block" id="advance_turb">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.advance_turb">[docs]</a>
<span class="k">def</span> <span class="nf">advance_turb</span><span class="p">(</span>
        <span class="n">akt</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">akv</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">tke</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">tke_np1</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">eps</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">c_mu</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">c_mu_prim</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">bvf</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">shear2</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">hz</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">],</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tke_sfc_bc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tke_btm_bc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eps_sfc_bc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eps_btm_bc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">keps_params</span><span class="p">:</span> <span class="n">KepsParameters</span><span class="p">,</span>
        <span class="n">do_tke</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate TKE or :math:`\varepsilon` quantities.</span>

<span class="sd">    First the shear and buoyancy production are computed, then they are used in</span>
<span class="sd">    the building of the tridiagonal problem, the boundary conditions are then</span>
<span class="sd">    added and finally the tridiagonal problem is solved.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    akt : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current eddy-diffusivity on the interfaces of the cells</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    akv : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current eddy-viscosity on the interfaces of the cells</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    tke : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current turbulent kinetic energy (TKE) denoted :math:`k` on the</span>
<span class="sd">        interfaces of the cells</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]`.</span>
<span class="sd">    tke_np1 : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Turbulent kinetic energy (TKE) denoted :math:`k` on the interfaces of</span>
<span class="sd">        the cells at next step (usefull only for :math:`\varepsilon`</span>
<span class="sd">        integration) :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]`.</span>
<span class="sd">    eps : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current TKE dissipation denoted :math:`\varepsilon` on the interfaces</span>
<span class="sd">        of the cells :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    c_mu : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current :math:`c_\mu` in GLS formalisim on the interfaces of the cells</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_mu_prim : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current :math:`c_\mu&#39;` in GLS formalisim on the interfaces of the cells</span>
<span class="sd">        :math:`[\text{dimensionless}]`.</span>
<span class="sd">    bvf : float(nz+1)</span>
<span class="sd">        Current Brunt–Väisälä frequency squared :math:`N^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text s^{-2}\right]`.</span>
<span class="sd">    shear2 : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current shear production squared :math:`S_h^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    hz : Float[~jax.Array, &#39;nz&#39;]</span>
<span class="sd">        Thickness of cells from deepest to shallowest :math:`[\text m]`.</span>
<span class="sd">    dt : float</span>
<span class="sd">        Time-step of the forward model :math:`[\text s]`.</span>
<span class="sd">    tke_sfc_bc : float</span>
<span class="sd">        TKE value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-3}\right]`).</span>
<span class="sd">    tke_btm_bc : float</span>
<span class="sd">        TKE value for bottom boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-3}\right]`).</span>
<span class="sd">    eps_sfc_bc : float</span>
<span class="sd">        :math:`\varepsilon` value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-4}\right]`).</span>
<span class="sd">    eps_btm_bc : float</span>
<span class="sd">        :math:`\varepsilon` value for surface boundary condition (Dirichlet</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]` or Neumann</span>
<span class="sd">        :math:`\left[\text m ^3 \cdot \text s ^{-4}\right]`).</span>
<span class="sd">    keps_params : KepsParameters</span>
<span class="sd">        Values of the parameters used by :math:`k-\varepsilon`.</span>
<span class="sd">    do_tke : bool</span>
<span class="sd">        If :code:`True` solve the equation for TKE, else for</span>
<span class="sd">        :math:`\varepsilon`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vec : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        TKE or :math:`\varepsilon` at next step (depending on :code:`do_tke`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># fill the matrix off-diagonal terms for the tridiagonal problem</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">ak_vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">akv</span><span class="o">/</span><span class="n">keps_params</span><span class="o">.</span><span class="n">sig_k</span><span class="p">,</span> <span class="n">akv</span><span class="o">/</span><span class="n">keps_params</span><span class="o">.</span><span class="n">sig_eps</span><span class="p">)</span>
    <span class="n">a_in</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ak_vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">hz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">c_in</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ak_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">/</span> <span class="n">hz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># shear and buoyancy production</span>
    <span class="n">s_prod_tke</span> <span class="o">=</span> <span class="n">akv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">shear2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">b_prod_tke</span> <span class="o">=</span> <span class="o">-</span><span class="n">akt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">bvf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s_prod_eps</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_eps1</span><span class="o">*</span><span class="n">c_mu</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">shear2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">b_prod_eps</span> <span class="o">=</span> <span class="o">-</span><span class="n">c_mu_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">c_eps3m</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">bvf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
         <span class="n">keps_params</span><span class="o">.</span><span class="n">c_eps3p</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">bvf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">s_prod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">s_prod_tke</span><span class="p">,</span> <span class="n">s_prod_eps</span><span class="p">)</span>
    <span class="n">b_prod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">b_prod_tke</span><span class="p">,</span> <span class="n">b_prod_eps</span><span class="p">)</span>

    <span class="c1"># diagonal and f term</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">hz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hz</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">f_tke_in</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">b_prod</span><span class="o">+</span><span class="n">s_prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="n">b_prod</span><span class="o">+</span><span class="n">s_prod</span><span class="p">)),</span>
                            <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">s_prod</span><span class="p">))</span>
    <span class="n">f_eps_in</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">b_prod</span><span class="o">+</span><span class="n">s_prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="n">b_prod</span><span class="o">+</span><span class="n">s_prod</span><span class="p">)),</span>
                            <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">s_prod</span><span class="p">))</span>
    <span class="n">f_in</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">f_tke_in</span><span class="p">,</span> <span class="n">f_eps_in</span><span class="p">)</span>
    <span class="n">b_tke_in</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">b_prod</span> <span class="o">+</span> <span class="n">s_prod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">a_in</span> <span class="o">-</span> <span class="n">c_in</span><span class="p">,</span>
        <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b_prod</span><span class="p">)</span><span class="o">/</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">a_in</span> <span class="o">-</span> <span class="n">c_in</span><span class="p">)</span>
    <span class="n">b_eps_in</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">b_prod</span> <span class="o">+</span> <span class="n">s_prod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">keps_params</span><span class="o">.</span><span class="n">c_eps2</span><span class="o">*</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tke_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">a_in</span> <span class="o">-</span> <span class="n">c_in</span><span class="p">,</span>
        <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">keps_params</span><span class="o">.</span><span class="n">c_eps2</span><span class="o">*</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tke_np1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
             <span class="n">dt</span><span class="o">*</span><span class="n">b_prod</span><span class="o">/</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">a_in</span> <span class="o">-</span> <span class="n">c_in</span><span class="p">)</span>
    <span class="n">b_in</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">b_tke_in</span><span class="p">,</span> <span class="n">b_eps_in</span><span class="p">)</span>

    <span class="c1"># surface boundary condition</span>
    <span class="n">dir_sfc</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">dir_sfc</span>
    <span class="n">a_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ak_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">b_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ak_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">sfc_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">tke_sfc_bc</span><span class="p">,</span> <span class="n">eps_sfc_bc</span><span class="p">)</span>
    <span class="n">f_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="n">sfc_bc</span><span class="p">,</span> <span class="n">hz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">sfc_bc</span><span class="p">)</span>

    <span class="c1"># bottom boundary condition</span>
    <span class="n">dir_btm</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">dir_btm</span>
    <span class="n">b_btm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ak_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">c_btm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_sfc</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ak_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ak_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">btm_bc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">tke_btm_bc</span><span class="p">,</span> <span class="n">eps_btm_bc</span><span class="p">)</span>
    <span class="n">f_btm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dir_btm</span><span class="p">,</span> <span class="n">btm_bc</span><span class="p">,</span> <span class="n">hz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">btm_bc</span><span class="p">)</span>

    <span class="c1"># vectors rassembly</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">a_in</span><span class="p">,</span> <span class="n">a_sfc</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">b_btm</span><span class="p">,</span> <span class="n">b_in</span><span class="p">,</span> <span class="n">b_sfc</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">c_btm</span><span class="p">,</span> <span class="n">c_in</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">f_btm</span><span class="p">,</span> <span class="n">f_in</span><span class="p">,</span> <span class="n">f_sfc</span><span class="p">)</span>

    <span class="c1"># solve tridiagonal problem</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">tridiag_solve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">vec_min</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do_tke</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">tke_min</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">eps_min</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vec_min</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vec</span></div>



<div class="viewcode-block" id="compute_diag">
<a class="viewcode-back" href="../../rst_files/api/closures/k_epsilon.html#closures.k_epsilon.compute_diag">[docs]</a>
<span class="k">def</span> <span class="nf">compute_diag</span><span class="p">(</span>
        <span class="n">tke</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">eps</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">bvf</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">shear2</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
        <span class="n">keps_params</span><span class="p">:</span> <span class="n">KepsParameters</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
               <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">],</span>
               <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;nz+1&#39;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the diagnostic variables of :math:`k-\varepsilon` closure.</span>

<span class="sd">    This function first apply the Galperin limitation, then it computes</span>
<span class="sd">    :math:`c_\mu&#39;` and :math:`c_\mu` with the stability function, and finally</span>
<span class="sd">    it computes the eddy-diffusivity and viscosity with these variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tke : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Turbulent kinetic energy (TKE) denoted :math:`k` on the interfaces of</span>
<span class="sd">        the cells at next step</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-2}\right]`.</span>
<span class="sd">    eps : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        TKE dissipation denoted :math:`\varepsilon` on the interfaces of the</span>
<span class="sd">        cells at next step :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    bvf : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current Brunt–Väisälä frequency squared :math:`N^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text s^{-2}\right]`.</span>
<span class="sd">    shear2 : Float[~jax.Array, &#39;nz+1&#39;]</span>
<span class="sd">        Current shear production squared :math:`S_h^2` on cell interfaces</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    keps_params : KepsParameters</span>
<span class="sd">        Values of the parameters used by :math:`k-\varepsilon`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    akt : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        Eddy-diffusivity on the interfaces of the cells at next step</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    akv : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        Eddy-viscosity on the interfaces of the cells at next step</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-1}\right]`.</span>
<span class="sd">    eps : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        TKE dissipation denoted :math:`\varepsilon` on the interfaces</span>
<span class="sd">        of the cells at next step</span>
<span class="sd">        :math:`\left[\text m ^2 \cdot \text s ^{-3}\right]`.</span>
<span class="sd">    c_mu : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        :math:`c_\mu` in GLS formalisim on the interfaces of the cells at next</span>
<span class="sd">        step :math:`[\text{dimensionless}]`.</span>
<span class="sd">    c_mu_prim : Float[Array, &#39;nz+1&#39;]</span>
<span class="sd">        :math:`c_\mu&#39;` in GLS formalisim on the interfaces of the cells at next</span>
<span class="sd">        step :math:`[\text{dimensionless}]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parameters</span>
    <span class="n">akv_min</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">akv_min</span>
    <span class="n">akt_min</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">akt_min</span>
    <span class="n">eps_min</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">eps_min</span>
    <span class="n">sf_d0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d0</span>
    <span class="n">sf_d1</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d1</span>
    <span class="n">sf_d2</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d2</span>
    <span class="n">sf_d3</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d3</span>
    <span class="n">sf_d4</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d4</span>
    <span class="n">sf_d5</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_d5</span>
    <span class="n">sf_n0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_n0</span>
    <span class="n">sf_n1</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_n1</span>
    <span class="n">sf_n2</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_n2</span>
    <span class="n">sf_nb0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_nb0</span>
    <span class="n">sf_nb1</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_nb1</span>
    <span class="n">sf_nb2</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">sf_nb2</span>
    <span class="n">lim_am0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am0</span>
    <span class="n">lim_am1</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am1</span>
    <span class="n">lim_am2</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am2</span>
    <span class="n">lim_am3</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am3</span>
    <span class="n">lim_am4</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am4</span>
    <span class="n">lim_am5</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am5</span>
    <span class="n">lim_am6</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">lim_am6</span>
    <span class="n">c_mu0</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu0</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rn</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_p</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_m</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">gls_n</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">rp</span><span class="o">/</span><span class="n">rn</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="n">rm</span><span class="o">/</span><span class="n">rn</span>
    <span class="n">e3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">rn</span>

    <span class="c1"># minimum value of alpha_n to ensure that alpha_m is positive</span>
    <span class="n">alpha_n_min</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">sf_d1</span> <span class="o">+</span> <span class="n">sf_nb0</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sf_d1</span> <span class="o">+</span> <span class="n">sf_nb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> \
        <span class="mf">4.0</span><span class="o">*</span><span class="n">sf_d0</span><span class="o">*</span><span class="p">(</span><span class="n">sf_d4</span> <span class="o">+</span> <span class="n">sf_nb1</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sf_d4</span> <span class="o">+</span> <span class="n">sf_nb1</span><span class="p">)</span>

    <span class="c1"># Galperin limitation : l &lt;= l_li</span>
    <span class="n">l_lim</span> <span class="o">=</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">galp</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> \
        <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">bvf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># limitation (use MAX because rn is negative)</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="n">c_mu0</span><span class="o">**</span><span class="n">rp</span> <span class="o">*</span> <span class="n">l_lim</span><span class="o">**</span><span class="n">rn</span> <span class="o">*</span> <span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">rm</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cff</span><span class="p">))</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">c_mu0</span><span class="o">**</span><span class="n">e1</span> <span class="o">*</span> <span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">e2</span> <span class="o">*</span> <span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">e3</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">eps_min</span><span class="p">)</span>

    <span class="c1"># compute alpha_n and alpha_m</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="p">(</span><span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">epsilon</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">alpha_m</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="n">shear2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="n">bvf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># limitation of alpha_n and alpha_m</span>
    <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.73</span><span class="o">*</span><span class="n">alpha_n_min</span><span class="p">,</span> <span class="n">alpha_n</span><span class="p">),</span> <span class="mf">1e10</span><span class="p">)</span>
    <span class="n">alpha_m_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">lim_am0</span> <span class="o">+</span> <span class="n">lim_am1</span><span class="o">*</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">lim_am2</span><span class="o">*</span><span class="n">alpha_n</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
        <span class="n">lim_am3</span><span class="o">*</span><span class="n">alpha_n</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lim_am4</span> <span class="o">+</span> <span class="n">lim_am5</span><span class="o">*</span><span class="n">alpha_n</span> <span class="o">+</span> \
        <span class="n">lim_am6</span><span class="o">*</span><span class="n">alpha_n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">alpha_m</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">alpha_m</span><span class="p">,</span> <span class="n">alpha_m_max</span><span class="p">)</span>

    <span class="c1"># compute stability functions</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">sf_d0</span> <span class="o">+</span> <span class="n">sf_d1</span><span class="o">*</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">sf_d2</span><span class="o">*</span><span class="n">alpha_m</span> <span class="o">+</span> <span class="n">sf_d3</span><span class="o">*</span><span class="n">alpha_n</span><span class="o">*</span><span class="n">alpha_m</span> \
        <span class="o">+</span> <span class="n">sf_d4</span><span class="o">*</span><span class="n">alpha_n</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sf_d5</span><span class="o">*</span><span class="n">alpha_m</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">denom</span>
    <span class="n">c_mu_in</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">sf_n0</span> <span class="o">+</span> <span class="n">sf_n1</span><span class="o">*</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">sf_n2</span><span class="o">*</span><span class="n">alpha_m</span><span class="p">)</span>
    <span class="n">c_mu</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_min</span><span class="p">,</span> <span class="n">c_mu_in</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_min</span><span class="p">)</span>
    <span class="n">c_mu_prim_in</span> <span class="o">=</span> <span class="n">cff</span><span class="o">*</span><span class="p">(</span><span class="n">sf_nb0</span> <span class="o">+</span> <span class="n">sf_nb1</span><span class="o">*</span><span class="n">alpha_n</span> <span class="o">+</span> <span class="n">sf_nb2</span><span class="o">*</span><span class="n">alpha_m</span><span class="p">)</span>
    <span class="n">c_mu_prim</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span>
        <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_prim_min</span><span class="p">,</span> <span class="n">c_mu_prim_in</span><span class="p">,</span> <span class="n">keps_params</span><span class="o">.</span><span class="n">c_mu_prim_min</span>
    <span class="p">)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">c_mu0</span><span class="o">**</span><span class="n">e1</span> <span class="o">*</span> <span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">e2</span> <span class="o">*</span> <span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">e3</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">eps_min</span><span class="p">)</span>

    <span class="c1"># finalize the computation of akv and akt</span>
    <span class="n">cff</span> <span class="o">=</span> <span class="n">tke</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">epsilon</span>
    <span class="n">akt_in</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">cff</span><span class="o">*</span><span class="n">c_mu_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">akt_min</span><span class="p">)</span>
    <span class="n">akv_in</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">cff</span><span class="o">*</span><span class="n">c_mu</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">akv_min</span><span class="p">)</span>

    <span class="n">akt_btm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">akt_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">akt_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">akt_min</span><span class="p">)</span>
    <span class="n">akt_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">akt_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">akt_in</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">akt_min</span><span class="p">)</span>
    <span class="n">akv_btm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">akv_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">akv_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">akv_min</span><span class="p">)</span>
    <span class="n">akv_sfc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">akv_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">akv_in</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">akv_min</span><span class="p">)</span>

    <span class="n">akt</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">akt_btm</span><span class="p">,</span> <span class="n">akt_in</span><span class="p">,</span> <span class="n">akt_sfc</span><span class="p">)</span>
    <span class="n">akv</span> <span class="o">=</span> <span class="n">add_boundaries</span><span class="p">(</span><span class="n">akv_btm</span><span class="p">,</span> <span class="n">akv_in</span><span class="p">,</span> <span class="n">akv_sfc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">akt</span><span class="p">,</span> <span class="n">akv</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">c_mu</span><span class="p">,</span> <span class="n">c_mu_prim</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Gabriel Mouttapa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>